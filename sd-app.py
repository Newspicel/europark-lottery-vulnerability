import requests
import time
import colorama
import uuid
from datetime import datetime
import os

import qrcode
from PIL import Image

headers = {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' 
}

admin_data = '{"userId":"6ea1e2a7-b60c-4ca5-a997-6ba55183424a","password":"admin"}'

admin_backend_data = '{"userId": "ad155ef7-6544-434e-a168-5bf80a10f48c", "password": "cook"}'

# users/create

#response = requests.post('https://sdapp.europapark.de/users/create', headers=headers, data=data)

#response = requests.post('https://sdapp.europapark.de/auth/login', headers=headers, data=data)

#response = requests.post('https://sdapp.europapark.de/lottery', headers=headers, data=data)

# check

def getConfig():
    header = {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + userLogin()["token"] 
}
    response = requests.get('https://sdapp.europapark.de/config', headers=header)
    print(response)
    return response.json()

def userLogin():
    header = {
        'Content-Type': 'application/json'    
    }
    response = requests.post('https://sdapp.europapark.de/auth/login', headers=header,data=admin_data)
    return response.json()

def createUser():
    header = {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + userLogin()["token"]
}   
    data = '{"password":"default"}'
    response = requests.post('https://sdapp.europapark.de/users/create', headers=header, data=data)
    return response.json()


def playLottery(token):
    headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    }

    response = requests.post('https://sdapp.europapark.de/lottery', headers=headers)
    return response.json()

def checkPrize(token, prizeid):
    headers = {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
    }

    data = '{"prizeId":"' + prizeid + '"}'
    response = requests.post('https://sdapp.europapark.de/check', headers=headers, data=data)
    return response.json()

def play():
    user = createUser()
    lottery_result = playLottery(user["token"])

    while(lottery_result['status'] != 'won'):
        user = createUser()
        lottery_result = playLottery(user["token"])

        print(lottery_result)

        # Red Lose
        if lottery_result['status'] == 'lost':
            print(colorama.Fore.RED + "Lost: " +user["userId"]+ " "+  colorama.Fore.RESET + str(lottery_result) )



    print(colorama.Fore.GREEN + "Won: " + user["userId"]+ " " + colorama.Fore.RESET + str(lottery_result) )
    
    img = qrcode.make(lottery_result['prizeId'])
    path = '.result/' + datetime.now().strftime("%Y/%m/%d") + '/'
    os.makedirs(path, exist_ok=True)
    img.save(path+ str(uuid.uuid4()) + '.png')

#print(getConfig())
#for i in range(0,20):
play()